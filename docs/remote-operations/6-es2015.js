(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{dgxB:function(t,e,o){"use strict";o.r(e),o.d(e,"ControlModule",(function(){return ot}));var n=o("PCNd"),i=o("tyNb"),a=o("fXoL"),r=o("XNiG"),c=o("lJxs"),l=o("pLZG"),s=o("GtPT"),b=o("2Vo4");class g extends s.ObjectLifecycleController{onInit(){super.onInit(),this._eventLog=[],this._eventLogSubject=new b.a(this._eventLog),this._eventLog$=this._eventLogSubject.asObservable(),this._activeAgentsInfo={activeLights:0,activeControls:0},this._activeAgentsInfoSubject=new r.a,this._activeAgentsInfo$=this._activeAgentsInfoSubject.asObservable()}onCommunicationManagerStarting(){this.observeObjectLifecycleInfoByCoreType("Identity",t=>"LightAgent"===t.name||"LightControlAgent"===t.name||"LightAgent & LightControlAgent"===t.name).subscribe(t=>{void 0!==t.added&&t.added.forEach(t=>this._updateActiveAgentsInfo(t.name.startsWith("LightAgent"),t.name.endsWith("LightControlAgent"),!0)),void 0!==t.removed&&t.removed.forEach(t=>this._updateActiveAgentsInfo(t.name.startsWith("LightAgent"),t.name.endsWith("LightControlAgent"),!1))})}get eventLog$(){return this._eventLog$}get activeAgentsInfo$(){return this._activeAgentsInfo$}clearEventLog(){this._eventLog=[],this._eventLogSubject.next(this._eventLog)}switchLights(t,e,o,n,i){const a=s.CallEvent.with(this.runtime.commonOptions.extra.lightControlOperation,{on:e,color:n,luminosity:o,switchTime:i},t),r=this.addCallToEventLog(a);this.communicationManager.publishCall(a).subscribe(t=>{this.addReturnToEventLog(t,r)})}_updateActiveAgentsInfo(t,e,o){o?(t&&this._activeAgentsInfo.activeLights++,e&&this._activeAgentsInfo.activeControls++):(t&&this._activeAgentsInfo.activeLights--,e&&this._activeAgentsInfo.activeControls--),this._activeAgentsInfoSubject.next(Object.assign({},this._activeAgentsInfo))}addCallToEventLog(t){const e=this.runtime.newUuid();return this._eventLog.unshift({correlationId:e,callEvent:t,callEventTime:Date.now(),returnEvents:[]}),this._eventLogSubject.next(this._eventLog),e}addReturnToEventLog(t,e){const o=this._eventLog.find(t=>t.correlationId===e);o&&(o.returnEvents.push({event:t,eventTime:Date.now()}),this._eventLogSubject.next(this._eventLog))}}var h=o("2ChS"),m=o("/t3+"),d=o("bTqV"),p=o("Qu3c"),u=o("NFeN");let f=(()=>{class t{constructor(t,e){this.data=t,this.bottomSheetRef=e}close(t){this.bottomSheetRef.dismiss(),t.preventDefault()}}return t.\u0275fac=function(e){return new(e||t)(a.Lb(h.a),a.Lb(h.d))},t.\u0275cmp=a.Fb({type:t,selectors:[["app-code-viewer-bottom-sheet"]],decls:32,vars:3,consts:[[1,"code-toolbar"],[1,"code-header"],[1,"code-key"],[1,"app-space-filler"],["mat-icon-button","","matTooltip","Close",1,"code-toolbar-button",3,"click"],["aria-hidden","false","aria-label","Close"],[1,"code-value"]],template:function(t,e){1&t&&(a.Qb(0,"mat-toolbar",0),a.Qb(1,"span",1),a.Qb(2,"code"),a.wc(3,"CallEvent.withData("),a.Pb(),a.Qb(4,"code",2),a.wc(5,"operation"),a.Pb(),a.Qb(6,"code"),a.wc(7,", "),a.Pb(),a.Qb(8,"code",2),a.wc(9,"parameters"),a.Pb(),a.Qb(10,"code"),a.wc(11,", "),a.Pb(),a.Qb(12,"code",2),a.wc(13,"contextFilter"),a.Pb(),a.Qb(14,"code"),a.wc(15,")"),a.Pb(),a.Pb(),a.Mb(16,"span",3),a.Qb(17,"button",4),a.Xb("click",(function(t){return e.close(t)})),a.Qb(18,"mat-icon",5),a.wc(19,"close "),a.Pb(),a.Pb(),a.Pb(),a.Qb(20,"pre",2),a.wc(21,"operation"),a.Pb(),a.Qb(22,"pre",6),a.wc(23),a.Pb(),a.Qb(24,"pre",2),a.wc(25,"parameters"),a.Pb(),a.Qb(26,"pre",6),a.wc(27),a.Pb(),a.Qb(28,"pre",2),a.wc(29,"contextFilter"),a.Pb(),a.Qb(30,"pre",6),a.wc(31),a.Pb()),2&t&&(a.zb(23),a.xc(e.data.operation),a.zb(4),a.xc(e.data.operationParameters),a.zb(4),a.xc(e.data.contextFilter))},directives:[m.a,d.b,p.a,u.a],styles:[".code-toolbar[_ngcontent-%COMP%]{font-size:17px;height:60px;padding-right:0;margin-top:-8px;margin-left:-16px;margin-right:-16px;width:calc(100% + 32px)}.code-toolbar-button[_ngcontent-%COMP%]{margin:0 16px}.code-key[_ngcontent-%COMP%]{color:#673ab7}.code-value[_ngcontent-%COMP%]{color:rgba(0,0,0,.87)}"]}),t})();var v=o("/Uk7"),C=o("tXAj"),w=o("Wp6s"),y=o("ofXK"),P=o("f0Cb"),L=o("kmnG"),x=o("d3UM"),Q=o("3Pt+"),I=o("1G5W"),k=o("FKr1");let T=(()=>{class t{constructor(t){this.matSelect=t,this.state="checked",this.options=[],this.value=[],this.destroyed=new r.a}ngAfterViewInit(){this.options=this.matSelect.options.map(t=>t.value),this.matSelect.options.changes.pipe(Object(I.a)(this.destroyed)).subscribe(t=>{this.options=this.matSelect.options.map(t=>t.value),this.updateState()}),this.value=this.matSelect.ngControl.control.value,this.matSelect.ngControl.valueChanges.pipe(Object(I.a)(this.destroyed)).subscribe(t=>{this.value=t,this.updateState()}),setTimeout(()=>{this.updateState()})}ngOnDestroy(){this.destroyed.next(),this.destroyed.complete()}onSelectAllClick(t){this.matSelect.ngControl.control.setValue("checked"===this.state?[]:this.options)}updateState(){const t=this.areArraysEqual(this.value,this.options);this.state=t?"checked":this.value.length>0?"indeterminate":"unchecked"}areArraysEqual(t,e){return[...t].sort().join(",")===[...e].sort().join(",")}}return t.\u0275fac=function(e){return new(e||t)(a.Lb(x.a,1))},t.\u0275cmp=a.Fb({type:t,selectors:[["app-mat-option-select-all"]],decls:4,vars:1,consts:[[1,"mat-option",3,"click"],[1,"mat-option-pseudo-checkbox",3,"state"],[1,"mat-option-text"]],template:function(t,e){1&t&&(a.Qb(0,"div",0),a.Xb("click",(function(t){return e.onSelectAllClick(t)})),a.Mb(1,"mat-pseudo-checkbox",1),a.Qb(2,"span",2),a.wc(3,"Select all"),a.Pb(),a.Pb()),2&t&&(a.zb(1),a.hc("state",e.state))},directives:[k.l],styles:[".mat-option[_ngcontent-%COMP%] {\n      border-bottom: 1px solid rgba(0, 0, 0, 0.12);\n      height: 3.5em;\n      line-height: 3.5em;\n  }"]}),t})();var O=o("0hV+"),S=o("1jcm"),z=o("5RNC"),E=o("jaxi"),M=o("bSwM"),A=o("7EHt"),F=o("MutI");const _=["controlCard"];function R(t,e){if(1&t&&(a.Qb(0,"mat-icon",12),a.wc(1),a.Pb()),2&t){const t=e.ngIf;a.hc("matTooltip",t.isOnline?"Connected to "+t.brokerHost:"Not connected to "+t.brokerHost),a.zb(1),a.yc(" ",t.isOnline?"wifi":"wifi_off"," ")}}function $(t,e){1&t&&(a.Qb(0,"mat-card-content"),a.wc(1,"Initializing..."),a.Pb())}function j(t,e){if(1&t&&(a.Qb(0,"mat-option",37),a.wc(1),a.Pb()),2&t){const t=e.$implicit;a.hc("value",t),a.zb(1),a.yc(" ",t," ")}}function B(t,e){if(1&t&&(a.Qb(0,"mat-option",37),a.wc(1),a.Pb()),2&t){const t=e.$implicit;a.hc("value",t),a.zb(1),a.yc(" ",t," ")}}function W(t,e){if(1&t&&(a.Qb(0,"mat-option",37),a.wc(1),a.Pb()),2&t){const t=e.$implicit;a.hc("value",t),a.zb(1),a.yc(" ",t," ")}}function D(t,e){if(1&t){const t=a.Rb();a.Qb(0,"a",44),a.Xb("click",(function(e){return a.mc(t),a.bc(2).onQrCodeClear(e)})),a.Qb(1,"mat-icon",45),a.wc(2," highlight_off "),a.Pb(),a.Pb()}}function q(t,e){if(1&t&&a.Mb(0,"mat-button-toggle",46),2&t){const t=e.$implicit,o=a.bc(2);a.rc("background-color",o.colorRgbaToCssRgba(t.rgba))("border-color",o.selectedCustomColor===t?"#ffd740":"rgba(0, 0, 0, 0.12)"),a.hc("value",t)("matTooltip",t.name)}}function H(t,e){if(1&t&&(a.Qb(0,"code",61),a.Qb(1,"span"),a.wc(2),a.Pb(),a.Qb(3,"span"),a.wc(4),a.cc(5,"json"),a.Pb(),a.Qb(6,"span"),a.wc(7),a.Pb(),a.Pb()),2&t){const t=a.bc().$implicit;a.zb(2),a.yc("light #",t.event.data.executionInfo.lightId," "),a.zb(2),a.yc("error message: ",a.dc(5,3,t.event.data.error.message)," , "),a.zb(3),a.yc("error code: ",t.event.data.error.code,"")}}function N(t,e){if(1&t&&(a.Qb(0,"code",53),a.Qb(1,"span"),a.wc(2),a.Pb(),a.Qb(3,"span"),a.wc(4),a.cc(5,"json"),a.Pb(),a.Qb(6,"span"),a.wc(7),a.cc(8,"date"),a.Pb(),a.Pb()),2&t){const t=a.bc().$implicit;a.zb(2),a.yc("light #",t.event.data.executionInfo.lightId," "),a.zb(2),a.yc("result: ",a.dc(5,3,t.event.data.result),", "),a.zb(3),a.yc("triggerTime: ",a.ec(8,5,t.event.data.executionInfo.triggerTime,"HH:mm:ss.SSS"),"")}}function X(t,e){if(1&t&&(a.Qb(0,"mat-list-item",56),a.Qb(1,"mat-icon",57),a.wc(2," arrow_forward"),a.Pb(),a.Qb(3,"h4",58),a.wc(4),a.cc(5,"date"),a.Pb(),a.uc(6,H,8,5,"code",59),a.uc(7,N,9,8,"code",60),a.Pb()),2&t){const t=e.$implicit;a.zb(1),a.hc("color",t.event.data.isError?"warn":""),a.zb(2),a.Db("control-event-log-warn",t.event.data.isError),a.zb(1),a.yc(" ReturnEvent @ ",a.ec(5,6,t.eventTime,"HH:mm:ss.SSS")," "),a.zb(2),a.hc("ngIf",t.event.data.isError),a.zb(1),a.hc("ngIf",!t.event.data.isError)}}function V(t,e){if(1&t){const t=a.Rb();a.Qb(0,"mat-list-item",50),a.Qb(1,"mat-icon",51),a.wc(2," arrow_back"),a.Pb(),a.Qb(3,"div",52),a.wc(4),a.cc(5,"date"),a.Qb(6,"code",53),a.Qb(7,"span"),a.wc(8),a.Pb(),a.Qb(9,"span"),a.wc(10),a.Pb(),a.Qb(11,"span"),a.wc(12),a.Pb(),a.Qb(13,"span"),a.wc(14),a.Pb(),a.Pb(),a.Qb(15,"a",54),a.Xb("click",(function(){a.mc(t);const o=e.$implicit;return a.bc(3).viewCallEventData(o.callEvent.data)})),a.Qb(16,"mat-icon",45),a.wc(17," code "),a.Pb(),a.Pb(),a.Pb(),a.uc(18,X,8,9,"mat-list-item",55),a.Pb()}if(2&t){const t=e.$implicit;a.Db("control-event-log-list-item-alternate",e.even),a.zb(4),a.yc(" CallEvent @ ",a.ec(5,8,t.callEventTime,"HH:mm:ss.SSS")," "),a.zb(4),a.yc("on: ",t.callEvent.data.getParameterByName("on"),", "),a.zb(2),a.yc("luminosity: ",t.callEvent.data.getParameterByName("luminosity"),", "),a.zb(2),a.yc("color: ",t.callEvent.data.getParameterByName("color"),", "),a.zb(2),a.yc("switchTime: ",t.callEvent.data.getParameterByName("switchTime")," "),a.zb(4),a.hc("ngForOf",t.returnEvents)}}function G(t,e){if(1&t){const t=a.Rb();a.Qb(0,"mat-expansion-panel"),a.Qb(1,"mat-expansion-panel-header"),a.Qb(2,"mat-panel-title"),a.wc(3," Event Log "),a.Pb(),a.Qb(4,"mat-panel-description"),a.wc(5),a.Pb(),a.Pb(),a.Qb(6,"mat-list",47),a.uc(7,V,19,11,"mat-list-item",48),a.Pb(),a.Qb(8,"mat-action-row"),a.Qb(9,"button",49),a.Xb("click",(function(){return a.mc(t),a.bc(2).clearEventLog()})),a.wc(10,"CLEAR"),a.Pb(),a.Pb(),a.Pb()}if(2&t){const t=e.ngIf,o=a.bc(2);a.zb(5),a.zc(" Call (",t.length,") \u22c5 Return (",o.getReturnEventsCount(t),") "),a.zb(2),a.hc("ngForOf",t)("ngForTrackBy",o.trackByEventLogEntries),a.zb(2),a.hc("disabled",!o.controlContainer)}}function U(t,e){if(1&t){const t=a.Rb();a.Qb(0,"mat-card-content"),a.Qb(1,"h1",13),a.wc(2),a.cc(3,"async"),a.Pb(),a.Qb(4,"h1",14),a.wc(5),a.cc(6,"async"),a.Pb(),a.Qb(7,"h4",15),a.wc(8,"SELECT CONTEXT FILTER"),a.Pb(),a.Qb(9,"mat-form-field",16),a.Qb(10,"mat-label"),a.wc(11,"Buildings"),a.Pb(),a.Qb(12,"mat-select",17),a.Xb("ngModelChange",(function(e){return a.mc(t),a.bc().selectedBuildings=e})),a.Mb(13,"app-mat-option-select-all"),a.uc(14,j,2,2,"mat-option",18),a.Pb(),a.Pb(),a.Qb(15,"mat-form-field",16),a.Qb(16,"mat-label"),a.wc(17,"Floors"),a.Pb(),a.Qb(18,"mat-select",17),a.Xb("ngModelChange",(function(e){return a.mc(t),a.bc().selectedFloors=e})),a.Mb(19,"app-mat-option-select-all"),a.uc(20,B,2,2,"mat-option",18),a.Pb(),a.Pb(),a.Qb(21,"mat-form-field",16),a.Qb(22,"mat-label"),a.wc(23,"Rooms"),a.Pb(),a.Qb(24,"mat-select",17),a.Xb("ngModelChange",(function(e){return a.mc(t),a.bc().selectedRooms=e})),a.Mb(25,"app-mat-option-select-all"),a.uc(26,W,2,2,"mat-option",18),a.Pb(),a.Pb(),a.Qb(27,"div",19),a.Qb(28,"mat-label",20),a.wc(29,"Light"),a.Pb(),a.Qb(30,"qrcode",21),a.Xb("dragover",(function(e){return a.mc(t),a.bc().onQrCodeDragOver(e)}))("drop",(function(e){return a.mc(t),a.bc().onQrCodeDrop(e)})),a.Pb(),a.uc(31,D,3,0,"a",22),a.Pb(),a.Qb(32,"h4"),a.wc(33,"SELECT OPERATION PARAMETERS"),a.Pb(),a.Qb(34,"div",23),a.Qb(35,"div",24),a.Qb(36,"div",25),a.Qb(37,"mat-icon",26),a.wc(38," wb_incandescent "),a.Pb(),a.wc(39," On/Off "),a.Pb(),a.Qb(40,"mat-slide-toggle",27),a.Xb("change",(function(e){return a.mc(t),a.bc().onOnOffToggle(e)}))("ngModelChange",(function(e){return a.mc(t),a.bc().onOff=e})),a.Pb(),a.Pb(),a.Qb(41,"div",28),a.Qb(42,"div",25),a.Qb(43,"mat-icon",29),a.wc(44," wb_sunny "),a.Pb(),a.wc(45," Luminosity "),a.Pb(),a.Qb(46,"mat-slider",30),a.Xb("change",(function(e){return a.mc(t),a.bc().onLuminosityChange(e)}))("ngModelChange",(function(e){return a.mc(t),a.bc().luminosityPercent=e})),a.Pb(),a.Pb(),a.Qb(47,"div",31),a.Qb(48,"div",25),a.Qb(49,"mat-icon",29),a.wc(50," color_lens "),a.Pb(),a.wc(51," Color "),a.Pb(),a.Qb(52,"mat-slider",32),a.Xb("input",(function(e){return a.mc(t),a.bc().onPrimaryColorDrag(e)}))("change",(function(e){return a.mc(t),a.bc().onPrimaryColorChange(e)}))("ngModelChange",(function(e){return a.mc(t),a.bc().primaryColorPosition=e})),a.Pb(),a.Qb(53,"mat-button-toggle-group",33),a.Xb("ngModelChange",(function(e){return a.mc(t),a.bc().selectedCustomColor=e}))("change",(function(e){return a.mc(t),a.bc().onCustomColorChange(e)})),a.uc(54,q,1,6,"mat-button-toggle",34),a.Pb(),a.Pb(),a.Qb(55,"div",28),a.Qb(56,"div",25),a.Qb(57,"mat-icon",35),a.wc(58," timer "),a.Pb(),a.wc(59," Switch time "),a.Pb(),a.Qb(60,"mat-button-toggle-group",36),a.Xb("ngModelChange",(function(e){return a.mc(t),a.bc().switchTime=e}))("change",(function(e){return a.mc(t),a.bc().onSwitchTimeChange(e)})),a.Qb(61,"mat-button-toggle",37),a.wc(62,"Immediate"),a.Pb(),a.Qb(63,"mat-button-toggle",37),a.wc(64,"5sec"),a.Pb(),a.Qb(65,"mat-button-toggle",37),a.wc(66,"10sec"),a.Pb(),a.Qb(67,"mat-button-toggle",37),a.wc(68,"20sec"),a.Pb(),a.Qb(69,"mat-button-toggle",37),a.wc(70,"30sec"),a.Pb(),a.Qb(71,"mat-button-toggle",37),a.wc(72,"60sec"),a.Pb(),a.Pb(),a.Pb(),a.Pb(),a.Qb(73,"div",38),a.Qb(74,"button",39),a.Xb("click",(function(){return a.mc(t),a.bc().switchLights()})),a.wc(75,"Switch lights "),a.Pb(),a.Qb(76,"mat-checkbox",40),a.Xb("ngModelChange",(function(e){return a.mc(t),a.bc().autoSwitch=e})),a.wc(77," Auto switch on parameter changes "),a.Pb(),a.Mb(78,"div",41),a.Qb(79,"button",42),a.Xb("click",(function(){return a.mc(t),a.bc().openCodeViewer()})),a.Qb(80,"mat-icon",43),a.wc(81,"code "),a.Pb(),a.Pb(),a.Pb(),a.uc(82,G,11,5,"mat-expansion-panel",9),a.cc(83,"async"),a.Pb()}if(2&t){const t=a.bc();var o,n;a.zb(2),a.yc("# Lights: ",null==(o=a.dc(3,47,t.activeAgentsInfo$))?null:o.activeLights,""),a.zb(3),a.yc("# Controls: ",null==(n=a.dc(6,49,t.activeAgentsInfo$))?null:n.activeControls,""),a.zb(7),a.hc("ngModel",t.selectedBuildings)("disabled",!!t.selectedLightId),a.zb(2),a.hc("ngForOf",t.availableBuildings),a.zb(4),a.hc("ngModel",t.selectedFloors)("disabled",!!t.selectedLightId),a.zb(2),a.hc("ngForOf",t.availableFloors),a.zb(4),a.hc("ngModel",t.selectedRooms)("disabled",!!t.selectedLightId),a.zb(2),a.hc("ngForOf",t.availableRooms),a.zb(4),a.rc("opacity",t.selectedLightId?1:.3),a.hc("matTooltip",t.selectedLightId?t.selectedLightUrl:"Drop QR Code of a light here to switch this light only")("title","")("qrdata",t.selectedLightUrl||"coaty.io")("elementType","svg")("errorCorrectionLevel","M")("width",80)("margin",0),a.zb(1),a.hc("ngIf",t.selectedLightId),a.zb(9),a.hc("color","accent")("labelPosition","before")("ngModel",t.onOff),a.zb(6),a.hc("min",0)("max",100)("tickInterval",10)("step",1)("thumbLabel",!0)("ngModel",t.luminosityPercent),a.zb(6),a.hc("min",0)("max",t.primaryColorPositionMax)("step",1)("thumbLabel",!0)("displayWith",t.primaryColorThumbDisplayer)("ngModel",t.primaryColorPosition),a.zb(1),a.hc("ngModel",t.selectedCustomColor),a.zb(1),a.hc("ngForOf",t.customColors),a.zb(6),a.hc("ngModel",t.switchTime),a.zb(1),a.hc("value",0),a.zb(2),a.hc("value",5e3),a.zb(2),a.hc("value",1e4),a.zb(2),a.hc("value",2e4),a.zb(2),a.hc("value",3e4),a.zb(2),a.hc("value",6e4),a.zb(5),a.hc("ngModel",t.autoSwitch),a.zb(6),a.hc("ngIf",a.dc(83,51,t.eventLog$))}}function J(t,e){if(1&t){const t=a.Rb();a.Qb(0,"mat-card-actions"),a.Qb(1,"button",62),a.Xb("click",(function(){return a.mc(t),a.bc().openLightApp()})),a.wc(2,"NEW LIGHT "),a.Pb(),a.Qb(3,"a",63),a.wc(4,"NEW LIGHT IN TAB "),a.Pb(),a.Qb(5,"a",64),a.wc(6,"NEW LIGHT CONTROL "),a.Pb(),a.Pb()}}function K(t,e){if(1&t&&(a.Qb(0,"div"),a.wc(1),a.cc(2,"date"),a.Pb()),2&t){const t=e.ngIf;a.zb(1),a.yc("Last switch operation: ",a.ec(2,1,null==t[0]?null:t[0].callEventTime,"HH:mm:ss.SSS"),"")}}function Y(t,e){1&t&&(a.Qb(0,"div"),a.wc(1,"Last switch operation:"),a.Pb())}function Z(t,e){if(1&t&&(a.Qb(0,"div",65),a.Qb(1,"a",66),a.Mb(2,"img",67),a.Pb(),a.Qb(3,"a",68),a.Mb(4,"img",69),a.Pb(),a.Pb()),2&t){const t=e.ngIf;a.zb(1),a.hc("matTooltip",(null==t?null:t.packageInfo.name)+"@"+(null==t?null:t.packageInfo.version)+" on GitHub")}}const tt=[{path:"",component:(()=>{class t{constructor(t,e,o,n,i){this.appContext=t,this.bottomSheet=e,this.changeRef=o,this.route=n,this.autoSwitch=!1,this.primaryColorPositionMax=1e3,this.currentClock$=new r.a,this.appContext.setContext("Light Control"),this.startClock(),this.connectControlController(i)}ngOnInit(){this.route.queryParamMap.pipe(Object(c.a)(t=>t.get("light_id")),Object(l.a)(t=>!!t)).subscribe(t=>{setTimeout(()=>{this.selectedLightId=t,this.selectedLightUrl=window.location.href})})}ngAfterContentInit(){setTimeout(()=>{this.updateColorSliderThumb(this.primaryColorPosition)})}ngOnDestroy(){this.stopClock(),this.controlContainer&&this.controlContainer.shutdown()}onOnOffToggle(t){this.autoSwitch&&this.switchLights()}onLuminosityChange(t){this.autoSwitch&&this.switchLights()}primaryColorThumbDisplayer(t){return""}onPrimaryColorDrag(t){this.updateColorSliderThumb(t.value),this.selectedCustomColor=void 0}onPrimaryColorChange(t){this.autoSwitch&&this.switchLights()}onCustomColorChange(t){t.source.checked&&(this.updateColorSliderThumb(-1),this.autoSwitch&&this.switchLights())}onSwitchTimeChange(t){this.autoSwitch&&this.switchLights()}onQrCodeDragOver(t){t.dataTransfer.types.includes("text/qrcode")&&t.preventDefault()}onQrCodeDrop(t){const e=t.dataTransfer.getData("text/qrcode"),o=e.lastIndexOf("?light_id=");-1!==o&&(this.selectedLightId=e.substr(o+10),this.selectedLightUrl=e),t.preventDefault()}onQrCodeClear(t){this.selectedLightId=void 0,this.selectedLightUrl=void 0}switchLights(){this.controlContainer.getController("ControlController").switchLights(this.createContextFilter(),this.onOff,this.luminosity,this.effectiveColor,this.switchTime)}openCodeViewer(){this.bottomSheet.open(f,{data:this.getFormattedEventData(this.onOff,this.luminosity,this.effectiveColor,this.switchTime,this.createContextFilter())})}openLightApp(){this.openLightAppInPopup()}viewCallEventData(t){console.log(t.filter),this.bottomSheet.open(f,{data:this.getFormattedEventData(t.getParameterByName("on"),t.getParameterByName("luminosity"),t.getParameterByName("color"),t.getParameterByName("switchTime"),t.filter)})}clearEventLog(){this.controlContainer.getController("ControlController").clearEventLog()}get luminosity(){return this.luminosityPercent/100}get effectiveColor(){if(this.selectedCustomColor)return this.selectedCustomColor.rgba;const t=this.colorPositionToRgba(this.primaryColorPosition);return t[3]=.75,t}colorRgbaToCssRgba(t){return`rgba(${t[0]}, ${t[1]}, ${t[2]}, ${t[3]})`}getReturnEventsCount(t){return t.reduce((t,e)=>t+e.returnEvents.length,0)}trackByEventLogEntries(t,e){return e.correlationId}startClock(){let t=Date.now();this.currentClock$.next(t),this.isClockStopped=!1;const e=()=>{this.isClockStopped||requestAnimationFrame(()=>{const o=Date.now();o-t>=1e3&&this.currentClock$.next(t=o),e()})};e()}stopClock(){this.isClockStopped=!0}initContextFilterBindings(t,e){const o=(t,e)=>Array.from({length:e-t+1},(e,o)=>o+t);this.availableBuildings=o(t.building.min,t.building.max),this.availableFloors=o(t.floor.min,t.floor.max),this.availableRooms=o(t.room.min,t.room.max),this.selectedBuildings=e.initialContextFilterBuildings,this.selectedFloors=e.initialContextFilterFloors,this.selectedRooms=e.initialContextFilterRooms}createContextFilter(){return this.selectedLightId?{conditions:["lightId",s.filterOp.equals(this.selectedLightId)]}:{conditions:{and:[["building",s.filterOp.in(this.selectedBuildings)],["floor",s.filterOp.in(this.selectedFloors)],["room",s.filterOp.in(this.selectedRooms)]]}}}initOperationParams(t){this.onOff=t.initialOpParamOnOff,this.luminosityPercent=100*t.initialOpParamLuminosity,this.primaryColorPosition=this.rgbaToColorPosition(t.initialOpParamPrimaryColor),this.customColors=t.customColors,this.switchTime=t.initialSwitchTime}connectControlController(t){t.resolveContainer("LightControlAgent","ControlController",g).then(t=>{this.controlContainer=t;const e=t.getController("ControlController");this.initBrokerConnectionInfo(e.options),this.initContextFilterBindings(t.runtime.commonOptions.extra.lightContextRanges,e.options),this.initOperationParams(e.options),this.eventLog$=e.eventLog$,this.activeAgentsInfo$=e.activeAgentsInfo$,this.changeRef.detectChanges(),this.appContext.setContext("Light Control #"+t.identity.objectId)}).catch(t=>{throw new Error("Agent container for ControlComponent couldn't be resolved: "+t)})}initBrokerConnectionInfo(t){this.brokerConnectionInfo$=this.controlContainer.communicationManager.observeCommunicationState().pipe(Object(c.a)(t=>({state:t,isOnline:t===s.CommunicationState.Online,brokerHost:this.controlContainer.communicationManager.options.brokerUrl})))}openLightAppInPopup(){const t=this.controlContainer.getController("ControlController").options,e=window.open("./light","_blank",`toolbar=no,resizable=no,status=no,location=no,menubar=no,titlebar=no,width=${t.lightWindowWidth},height=${t.lightWindowHeight}`),o={screenLeft:e.screenLeft,screenTop:e.screenTop,outerWidth:e.outerWidth,outerHeight:e.outerHeight,availTop:e.screen.availTop||0,availLeft:e.screen.availLeft||0,availWidth:e.screen.availWidth,availHeight:e.screen.availHeight};let n,i;if(this.currentLightWindowLayout){const t=this.currentLightWindowLayout.outerWidth,e=this.currentLightWindowLayout.outerHeight,o=this.currentLightWindowLayout.availTop,a=this.currentLightWindowLayout.availLeft,r=this.currentLightWindowLayout.availWidth;n=this.currentLightWindowLayout.screenLeft,i=this.currentLightWindowLayout.screenTop+e,i+e>=o+this.currentLightWindowLayout.availHeight&&(n+=t,i=o,n+t>=a+r&&(n=a,i=o))}else n=o.availLeft,i=o.availTop;e.moveTo(n,i),o.screenLeft=e.screenLeft,o.screenTop=e.screenTop,this.currentLightWindowLayout=o}updateColorSliderThumb(t){const e=this.colorPositionToRgba(t)||[255,255,255,0],o=this.cardElementRef.nativeElement.querySelector(".control-color-slider .mat-slider-thumb-label");o&&(o.style.backgroundColor=this.colorRgbaToCssRgba(e))}rgbaToColorPosition(t){const[e,o,n,i]=t,a=1/6;let r;if(255===e&&0===n)r=a*o/255;else if(255===o&&0===n)r=a+(255-a*e)/255;else if(0===e&&255===o)r=2*a+a*n/255;else if(0===e&&255===n)r=.5+(255-a*o)/255;else if(0===o&&255===n)r=4*a+a*e/255;else{if(255!==e||0!==o)return-1;r=5*a+(255-a*n)/255}return r*this.primaryColorPositionMax}colorPositionToRgba(t){if(-1===t)return;let e=0,o=0,n=0;const i=t/this.primaryColorPositionMax,a=1/6;return i<=a?(e=255,o=255*i/a,n=0):i<=2*a?(e=255-255*(i-a)/a,o=255,n=0):i<=.5?(e=0,o=255,n=255*(i-2*a)/a):i<=4*a?(e=0,o=255-255*(i-.5)/a,n=255):i<=5*a?(e=255*(i-4*a)/a,o=0,n=255):(e=255,o=0,n=255-255*(i-5*a)/a),[Math.round(e),Math.round(o),Math.round(n),1]}getFormattedEventData(t,e,o,n,i){const a=t=>JSON.stringify(t).replace(/,/g,", "),r=(t,e)=>Array.isArray(e)&&e.every(t=>!Array.isArray(t))?a(e):e,c=t=>(t=>t.replace(/\\/g,"").replace(/\"\[/g,"[").replace(/\]\"/g,"]").replace(/\"\{/g,"{").replace(/\}\"/g,"}"))(JSON.stringify(t,r,2));return{operation:c(this.controlContainer.runtime.commonOptions.extra.lightControlOperation),operationParameters:c({on:t,luminosity:e,color:o,switchTime:n}),contextFilter:(l=c((t=>{if(Array.isArray(t.conditions)){const e=t.conditions;return e[1]=`filterOp.${s.ObjectFilterOperator[e[1][0]]}(${JSON.stringify(e[1][1])})`,t}return t.conditions.and.forEach(t=>t[1]=`filterOp.${s.ObjectFilterOperator[t[1][0]]}(${a(t[1][1])})`),t})(i)),l.replace(/\"filterOp/g,"filterOp").replace(/\)\"/g,")"))};var l}}return t.\u0275fac=function(e){return new(e||t)(a.Lb(v.a),a.Lb(h.b),a.Lb(a.h),a.Lb(i.a),a.Lb(C.a))},t.\u0275cmp=a.Fb({type:t,selectors:[["app-control"]],viewQuery:function(t,e){var o;1&t&&a.qc(_,!0,a.l),2&t&&a.jc(o=a.Yb())&&(e.cardElementRef=o.first)},decls:27,vars:18,consts:[[1,"app-card"],["controlCard",""],["mat-card-avatar","",1,"control-card-header-avatar"],[1,"app-text-with-ellipsis"],["class","control-card-title-icon",3,"matTooltip",4,"ngIf"],[1,"control-time-overlay"],["mat-card-image","","src","./assets/images/light-control-image.jpg","alt","Key visual with a light bulb",1,"app-map-card-image-centered","app-keyvisual-layout"],["initializing",""],[4,"ngIf","ngIfElse"],[4,"ngIf"],["nolog",""],["class","app-card-footer-link-group",4,"ngIf"],[1,"control-card-title-icon",3,"matTooltip"],[1,"control-light-agents-info-overlay"],[1,"control-control-agents-info-overlay"],[1,"app-heading-no-top-margin"],[1,"control-form-field"],["multiple","",3,"ngModel","disabled","ngModelChange"],[3,"value",4,"ngFor","ngForOf"],[1,"control-context-qrcode-field"],[1,"control-context-qrcode-label"],[1,"control-context-qrcode",3,"matTooltip","title","qrdata","elementType","errorCorrectionLevel","width","margin","dragover","drop"],["class","control-context-qrcode-button","matTooltip","Remove light from context filter","aria-label","icon button to remove QR Code from context filter",3,"click",4,"ngIf"],[1,"control-operation-params"],[1,"control-operation-param","control-operation-param-no-grow"],[1,"control-operation-param-label"],["aria-label","light bulb icon",1,"app-mat-icon-flipped"],["aria-label","on/off switch",3,"color","labelPosition","ngModel","change","ngModelChange"],[1,"control-operation-param"],["aria-label","light bulb icon"],[3,"min","max","tickInterval","step","thumbLabel","ngModel","change","ngModelChange"],[1,"control-operation-param","control-operation-param-color"],[1,"control-color-slider",3,"min","max","step","thumbLabel","displayWith","ngModel","input","change","ngModelChange"],[3,"ngModel","ngModelChange","change"],[3,"value","matTooltip","background-color","border-color",4,"ngFor","ngForOf"],["aria-label","timer icon"],["aria-label","Switch time",1,"control-operation-param-time-switch-group",3,"ngModel","ngModelChange","change"],[3,"value"],[1,"control-operation-request"],["mat-flat-button","","color","primary",3,"click"],[3,"ngModel","ngModelChange"],[1,"app-space-filler"],["mat-mini-fab","","color","primary","matTooltip","View CallEvent data",3,"click"],["aria-label","View code of currently selected filter and parameters"],["matTooltip","Remove light from context filter","aria-label","icon button to remove QR Code from context filter",1,"control-context-qrcode-button",3,"click"],["color","primary"],[3,"value","matTooltip"],[1,"control-event-log-list"],["class","control-event-log-list-item",3,"control-event-log-list-item-alternate",4,"ngFor","ngForOf","ngForTrackBy"],["mat-button","","color","primary",3,"disabled","click"],[1,"control-event-log-list-item"],["matListIcon","",1,"control-event-log-call-icon"],["matLine","",1,"control-event-log-heading"],[1,"control-event-log-code"],["matTooltip","View CallEvent data","aria-label","icon button for viewing CallEvent data in bottom sheet",1,"control-code-icon",3,"click"],["matLine","","class","control-event-log-return-list-item",4,"ngFor","ngForOf"],["matLine","",1,"control-event-log-return-list-item"],["matListIcon","",3,"color"],[1,"control-event-log-heading"],["class","control-event-log-code control-event-log-warn",4,"ngIf"],["class","control-event-log-code",4,"ngIf"],[1,"control-event-log-code","control-event-log-warn"],["mat-button","","color","primary","matTooltip","Open new light in popup","aria-label","Button that opens a new light in a popup window",3,"click"],["mat-button","","color","primary","matTooltip","Open new light in new tab","aria-label","Button that opens a new light in a new tab","routerLink","/light","target","_blank"],["mat-button","","color","primary","matTooltip","Open new light control in new tab","aria-label","Button that opens a new light control in a new tab","routerLink","/control","target","_blank"],[1,"app-card-footer-link-group"],["mat-button","","href","https://github.com/coatyio/coaty-examples/tree/master/remote-operations/js","target","_blank",3,"matTooltip"],["src","./assets/images/github-icon.svg","alt","github-logo"],["mat-button","","href","https://coaty.io","target","_blank"],["src","./assets/images/coaty-logo-accent.svg","alt","coaty-logo"]],template:function(t,e){if(1&t&&(a.Qb(0,"mat-card",0,1),a.Qb(2,"mat-card-header"),a.Mb(3,"a",2),a.Qb(4,"mat-card-title",3),a.wc(5," Light Control "),a.Pb(),a.Qb(6,"mat-card-subtitle",3),a.wc(7),a.Pb(),a.uc(8,R,2,2,"mat-icon",4),a.cc(9,"async"),a.Pb(),a.Qb(10,"h1",5),a.wc(11),a.cc(12,"date"),a.cc(13,"async"),a.Pb(),a.Mb(14,"img",6),a.uc(15,$,2,0,"ng-template",null,7,a.vc),a.uc(17,U,84,53,"mat-card-content",8),a.Mb(18,"mat-divider"),a.uc(19,J,7,0,"mat-card-actions",9),a.Mb(20,"mat-divider"),a.Qb(21,"mat-card-footer"),a.uc(22,K,3,4,"div",8),a.cc(23,"async"),a.uc(24,Y,2,0,"ng-template",null,10,a.vc),a.uc(26,Z,5,1,"div",11),a.Pb(),a.Pb()),2&t){const t=a.kc(16),o=a.kc(25);a.zb(7),a.yc(" #",null==e.controlContainer?null:e.controlContainer.identity.objectId," "),a.zb(1),a.hc("ngIf",a.dc(9,9,e.brokerConnectionInfo$)),a.zb(3),a.xc(a.ec(12,11,a.dc(13,14,e.currentClock$),"HH:mm:ss")),a.zb(6),a.hc("ngIf",e.controlContainer)("ngIfElse",t),a.zb(2),a.hc("ngIf",e.controlContainer),a.zb(3),a.hc("ngIf",a.dc(23,16,e.eventLog$))("ngIfElse",o),a.zb(4),a.hc("ngIf",null==e.controlContainer?null:e.controlContainer.runtime.commonOptions.agentInfo)}},directives:[w.a,w.f,w.c,w.j,w.i,y.m,w.g,P.a,w.e,u.a,p.a,w.d,L.b,L.e,x.a,Q.g,Q.i,T,y.l,O.a,S.a,z.a,E.b,E.a,d.b,M.a,k.j,A.b,A.e,A.f,A.d,F.a,A.c,F.c,F.b,k.h,w.b,d.a,i.b],pipes:[y.b,y.e,y.g],styles:[".control-card-header-avatar{background-image:url(light-switch-avatar.jpg);background-size:cover}.control-card-title-icon{margin-left:auto;margin-right:32px}.control-light-agents-info-overlay{margin-top:-100px!important}.control-control-agents-info-overlay,.control-light-agents-info-overlay{color:#ff8c00;background-color:rgba(0,0,0,.5);position:absolute;left:16px;padding:4px}.control-control-agents-info-overlay{margin-top:-62px!important}.control-time-overlay{color:#fff;background-color:rgba(0,0,0,.5);position:absolute;margin-top:0!important;left:16px;padding:4px}.control-form-field{margin-right:16px}.control-context-qrcode-field{display:inline-block;position:relative}.control-context-qrcode-label{margin-right:12px;color:rgba(0,0,0,.54);font-size:14px;font-weight:400;display:inline-block;transform:translateY(-1.28125em) scale(.75) perspective(100px) translateZ(.001px)}.control-context-qrcode{display:inline-block;vertical-align:middle}.control-context-qrcode-button{cursor:pointer;position:absolute!important;left:10px;bottom:-4px}.control-operation-params{display:flex;align-items:center;flex-wrap:wrap}.control-operation-param{display:flex;align-items:center;flex:1 0 auto;margin-right:48px;margin-top:16px}.control-operation-param.control-operation-param-no-grow{flex:0 0 auto}.control-operation-param-label{align-self:center;display:flex;align-items:center}.control-operation-param-label>:first-child{margin-right:6px}.control-color-slider{background-origin:content-box;background-clip:content-box;background-position-y:center;background-size:100% 40%;background-repeat:no-repeat;background-image:linear-gradient(90deg,red,#ff0,#0f0,#0ff,#00f,#f0f,red)}.control-color-slider .mat-slider-thumb-label{background-color:transparent;transition:none!important}.control-color-slider .mat-slider-track-wrapper{display:none}.control-operation-param-color .mat-button-toggle-group{overflow:visible!important;height:20px}.control-operation-param-color .mat-button-toggle{overflow:hidden!important;width:20px;height:20px;border:2px solid rgba(0,0,0,.12)}.control-operation-param-time-switch-group{margin-left:8px}.control-operation-request{display:flex;flex-wrap:wrap;align-items:center;margin-top:24px;margin-bottom:32px}.control-operation-request>*{margin-right:16px!important}.control-event-log-list{padding-top:0!important;overflow-y:auto;max-height:250px}.control-event-log-list-item{height:auto!important}.control-event-log-list-item-alternate{background-color:#eceff1}.control-event-log-call-icon{align-self:flex-start}.control-event-log-warn{color:#f44336}.control-event-log-heading{font-size:16px!important;font-weight:400;margin:0!important}.control-event-log-heading.mat-line{margin-top:2px!important;margin-bottom:2px!important}.control-event-log-code{margin-left:16px;font-size:12px;vertical-align:middle}.control-event-log-return-list-item{height:32px!important}.control-event-log-return-list-item .mat-list-item-content{padding:2px 0!important}.control-code-icon{cursor:pointer}.control-code-icon mat-icon{vertical-align:bottom}"],encapsulation:2,changeDetection:0}),t})()}];let et=(()=>{class t{}return t.\u0275mod=a.Jb({type:t}),t.\u0275inj=a.Ib({factory:function(e){return new(e||t)},imports:[[i.c.forChild(tt)],i.c]}),t})(),ot=(()=>{class t{}return t.\u0275mod=a.Jb({type:t}),t.\u0275inj=a.Ib({factory:function(e){return new(e||t)},imports:[[n.a,et]]}),t})()}}]);