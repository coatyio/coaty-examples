function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function _createClass(t,e,n){return e&&_defineProperties(t.prototype,e),n&&_defineProperties(t,n),t}function _get(t,e,n){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,n){var o=_superPropBase(t,e);if(o){var i=Object.getOwnPropertyDescriptor(o,e);return i.get?i.get.call(n):i.value}})(t,e,n||t)}function _superPropBase(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=_getPrototypeOf(t)););return t}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&_setPrototypeOf(t,e)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function _createSuper(t){var e=_isNativeReflectConstruct();return function(){var n,o=_getPrototypeOf(t);if(e){var i=_getPrototypeOf(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return _possibleConstructorReturn(this,n)}}function _possibleConstructorReturn(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?_assertThisInitialized(t):e}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{powV:function(t,e,n){"use strict";n.r(e),n.d(e,"LightModule",(function(){return q}));var o,i=n("PCNd"),r=n("tyNb"),a=n("zP0r"),c=n("lJxs"),l=n("GtPT"),s=n("2Vo4"),g=function(t){_inherits(n,t);var e=_createSuper(n);function n(){return _classCallCheck(this,n),e.apply(this,arguments)}return _createClass(n,[{key:"onInit",value:function(){_get(_getPrototypeOf(n.prototype),"onInit",this).call(this),this._light=this.createLight(),this._lightContext=this.createLightContext(this.options.building,this.options.floor,this.options.room),this._lightStatus=this.createLightStatus(this.options.lightOn,this.options.lightColor,this.options.lightLuminosity),this._lightColorChangeSubject=new s.a(this.convertLightStatusToColor()),this._lightColorChange$=this._lightColorChangeSubject.asObservable()}},{key:"onCommunicationManagerStarting",value:function(){_get(_getPrototypeOf(n.prototype),"onCommunicationManagerStarting",this).call(this),this.observeCallEvents()}},{key:"observeCallEvents",value:function(){var t=this;return this.communicationManager.observeCall(this.runtime.commonOptions.extra.lightControlOperation,this._lightContext).subscribe((function(e){var n=e.data.getParameterByName("on"),o=e.data.getParameterByName("color"),i=e.data.getParameterByName("luminosity"),r=e.data.getParameterByName("switchTime");t.validateSwitchOpParams(n,o,i,r)?setTimeout((function(){t.light.isDefect?e.returnEvent(l.ReturnEvent.withError(1,"Light is defect",{lightId:t._light.objectId,triggerTime:Date.now()})):(t.updateLightStatus(n,o,i),t._lightColorChangeSubject.next(t.convertLightStatusToColor()),e.returnEvent(l.ReturnEvent.withResult(t._lightStatus.on,{lightId:t._light.objectId,triggerTime:Date.now()})))}),Math.max(0,void 0===r?0:r)):e.returnEvent(l.ReturnEvent.withError(l.RemoteCallErrorCode.InvalidParameters,l.RemoteCallErrorMessage.InvalidParameters,{lightId:t._light.objectId,triggerTime:Date.now()}))}))}},{key:"createLight",value:function(){return{coreType:"CoatyObject",objectType:"coaty.examples.remoteops.Light",objectId:this.runtime.newUuid(),name:"Light",isDefect:!1}}},{key:"createLightStatus",value:function(t,e,n){return{coreType:"CoatyObject",objectType:"coaty.examples.remoteops.LightStatus",objectId:this.runtime.newUuid(),name:"LightStatus",parentObjectId:this._light.objectId,on:t,luminosity:n,color:e}}},{key:"createLightContext",value:function(t,e,n){return{coreType:"CoatyObject",objectType:"coaty.examples.remoteops.LightContext",objectId:this.runtime.newUuid(),name:"LightContext",parentObjectId:this._light.objectId,lightId:this._light.objectId,building:t,floor:e,room:n}}},{key:"validateSwitchOpParams",value:function(t,e,n,o){return!(void 0!==t&&"boolean"!=typeof t||!(void 0===n||"number"==typeof n&&n>=0&&n<=1)||void 0!==o&&"number"!=typeof o||!function(t){return Array.isArray(t)&&4===t.length&&t[0]>=0&&t[0]<=255&&t[1]>=0&&t[1]<=255&&t[2]>=0&&t[2]<=255&&t[3]>=0&&t[3]<=1}(e)||0===e[0]&&0===e[1]&&0===e[2])}},{key:"updateLightStatus",value:function(t,e,n){var o=this._lightStatus,i=o.on,r=o.color,a=o.luminosity;void 0===t||t===i?void 0===e||e===r?void 0===n||n===a||(this._lightStatus=this.createLightStatus(i,r,n)):this._lightStatus=this.createLightStatus(i,e,void 0===n||n===a?a:n):this._lightStatus=this.createLightStatus(t,void 0===e||e===r?r:e,void 0===n||n===a?a:n)}},{key:"convertLightStatusToColor",value:function(){var t=this._lightStatus,e=t.on,n=t.color,o=t.luminosity;return e&&0!==o?"rgba(".concat(n[0],", ").concat(n[1],", ").concat(n[2],", ").concat((o*n[3]).toFixed(2),")"):"transparent"}},{key:"light",get:function(){return this._light}},{key:"lightContext",get:function(){return this._lightContext}},{key:"lightColorChange$",get:function(){return this._lightColorChange$}}]),n}(l.Controller),h=n("fXoL"),u=n("/Uk7"),d=n("ofXK"),b=n("tXAj"),f=n("Wp6s"),p=n("f0Cb"),m=n("NFeN"),C=n("Qu3c"),v=n("1jcm"),y=n("3Pt+"),k=n("DoL9"),x=n("5RNC"),_=n("bTqV"),w=((o=function(){function t(){_classCallCheck(this,t)}return _createClass(t,[{key:"transform",value:function(t,e){if(null!=t)return new Date}}]),t}()).\u0275fac=function(t){return new(t||o)},o.\u0275pipe=h.Mb({name:"dateNow",type:o,pure:!0}),o);function O(t,e){if(1&t&&(h.Sb(0,"mat-icon",10),h.yc(1),h.Rb()),2&t){var n=e.ngIf;h.kc("matTooltip",n.isOnline?"Connected to "+n.brokerHost:"Not connected to "+n.brokerHost),h.Bb(1),h.Ac(" ",n.isOnline?"wifi":"wifi_off"," ")}}function S(t,e){if(1&t&&h.Ob(0,"img",11),2&t){var n=e.ngIf,o=h.ec();h.vc("background-color",o.light.isDefect?"transparent":n)}}function R(t,e){1&t&&(h.Sb(0,"mat-card-content"),h.yc(1,"Initializing..."),h.Rb())}function I(t,e){if(1&t){var n=h.Tb();h.Sb(0,"mat-card-content",12),h.Sb(1,"div",13),h.Sb(2,"mat-slide-toggle",14),h.ac("ngModelChange",(function(t){return h.qc(n),h.ec().light.isDefect=t})),h.yc(3," Defect "),h.Rb(),h.Rb(),h.Sb(4,"qrcode",15,16),h.ac("dragstart",(function(t){h.qc(n);var e=h.oc(5);return h.ec().onQrCodeDrag(t,e)}))("click",(function(t){return h.qc(n),h.ec().onQrCodeClick(t)})),h.Rb(),h.Sb(6,"h4",17),h.yc(7,"CONTEXT"),h.Rb(),h.Sb(8,"div",18),h.Sb(9,"div",19),h.yc(10,"Building"),h.Rb(),h.Sb(11,"mat-slider",20),h.ac("ngModelChange",(function(t){return h.qc(n),h.ec().lightContext.building=t})),h.Rb(),h.Rb(),h.Sb(12,"div",18),h.Sb(13,"div",19),h.yc(14,"Floor"),h.Rb(),h.Sb(15,"mat-slider",20),h.ac("ngModelChange",(function(t){return h.qc(n),h.ec().lightContext.floor=t})),h.Rb(),h.Rb(),h.Sb(16,"div",18),h.Sb(17,"div",19),h.yc(18,"Room"),h.Rb(),h.Sb(19,"mat-slider",20),h.ac("ngModelChange",(function(t){return h.qc(n),h.ec().lightContext.room=t})),h.Rb(),h.Rb(),h.Rb()}if(2&t){var o=h.ec();h.Bb(2),h.kc("color","warn")("ngModel",o.light.isDefect),h.Bb(2),h.kc("title","")("qrdata",o.qrCodeUrl)("usesvg",!0)("level","M"),h.Bb(7),h.kc("min",o.lightContextRanges.building.min)("max",o.lightContextRanges.building.max)("tickInterval",o.lightContextRanges.building.tickInterval)("step",1)("thumbLabel",!0)("ngModel",o.lightContext.building),h.Bb(4),h.kc("min",o.lightContextRanges.floor.min)("max",o.lightContextRanges.floor.max)("tickInterval",o.lightContextRanges.floor.tickInterval)("step",1)("thumbLabel",!0)("tickInterval",10)("ngModel",o.lightContext.floor),h.Bb(4),h.kc("min",o.lightContextRanges.room.min)("max",o.lightContextRanges.room.max)("tickInterval",o.lightContextRanges.room.tickInterval)("step",1)("thumbLabel",!0)("tickInterval",10)("ngModel",o.lightContext.room)}}function P(t,e){if(1&t&&(h.Sb(0,"mat-card-footer",3),h.Sb(1,"div"),h.yc(2),h.fc(3,"date"),h.fc(4,"dateNow"),h.fc(5,"async"),h.Rb(),h.Sb(6,"div",21),h.Sb(7,"a",22),h.Ob(8,"img",23),h.Rb(),h.Sb(9,"a",24),h.Ob(10,"img",25),h.Rb(),h.Rb(),h.Rb()),2&t){var n=e.ngIf,o=h.ec();h.Bb(2),h.Ac("Last switched: ",h.hc(3,2,h.gc(4,5,h.gc(5,7,o.lastSwitched$)),"HH:mm:ss.SSS"),""),h.Bb(5),h.kc("matTooltip",(null==n?null:n.packageInfo.name)+"@"+(null==n?null:n.packageInfo.version)+" on GitHub")}}var j,L,M,T=[{path:"",component:(j=function(){function t(e,n,o){_classCallCheck(this,t),this.appContext=e,this.location=n,this.appContext.setContext("Light"),this.initNgModelBindings(),this.connectLightController(o)}return _createClass(t,[{key:"ngOnDestroy",value:function(){this.lightContainer&&this.lightContainer.shutdown()}},{key:"onQrCodeClick",value:function(t){window.open(this.qrCodeUrl,"_blank")}},{key:"onQrCodeDrag",value:function(t,e){e.hide(),t.dataTransfer.setData("text/plain",this.qrCodeUrl),t.dataTransfer.setData("text/qrcode",this.qrCodeUrl)}},{key:"getQrCodeUrl",value:function(){var t=this.location.prepareExternalUrl("/control?light_id=".concat(this.light?this.light.objectId:""));return window.location.protocol+"//"+window.location.host+t}},{key:"initNgModelBindings",value:function(){this.lightContext={building:0,floor:0,room:0},this.lightContextRanges={building:{min:0,max:0,tickInterval:1},floor:{min:0,max:0,tickInterval:1},room:{min:0,max:0,tickInterval:1}}}},{key:"connectLightController",value:function(t){var e=this;t.resolveContainer("LightAgent","LightController",g).then((function(t){e.lightContainer=t;var n=t.getController("LightController");e.lightContextRanges=t.runtime.commonOptions.extra.lightContextRanges,e.light=n.light,e.lightContext=n.lightContext,e.lightColor$=n.lightColorChange$,e.lastSwitched$=n.lightColorChange$.pipe(Object(a.a)(1)),e.qrCodeUrl=e.getQrCodeUrl(),e.initBrokerConnectionInfo(n.options),e.appContext.setContext("Light #".concat(e.light.objectId))})).catch((function(t){throw new Error("Agent container for LightComponent couldn't be resolved: ".concat(t))}))}},{key:"initBrokerConnectionInfo",value:function(t){var e=this;this.brokerConnectionInfo$=this.lightContainer.communicationManager.observeCommunicationState().pipe(Object(c.a)((function(t){return{state:t,isOnline:t===l.CommunicationState.Online,brokerHost:e.lightContainer.communicationManager.options.brokerUrl}})))}}]),t}(),j.\u0275fac=function(t){return new(t||j)(h.Nb(u.a),h.Nb(d.i),h.Nb(b.a))},j.\u0275cmp=h.Hb({type:j,selectors:[["app-light"]],decls:17,vars:15,consts:[[1,"app-card","light-card-dark"],["mat-card-avatar","",1,"light-card-header-avatar"],[1,"app-text-with-ellipsis"],[1,"light-card-subtitle-dark"],["class","light-card-title-icon",3,"matTooltip",4,"ngIf"],["mat-card-image","","class","app-map-card-image-centered light-card-image-mask","src","./assets/images/light-bulb-mask.png","alt","Photo of a light bulb",3,"background-color",4,"ngIf","ngIfElse"],["initializing",""],["class","light-card-content",4,"ngIf"],[1,"light-card-divider-dark"],["class","light-card-subtitle-dark",4,"ngIf"],[1,"light-card-title-icon",3,"matTooltip"],["mat-card-image","","src","./assets/images/light-bulb-mask.png","alt","Photo of a light bulb",1,"app-map-card-image-centered","light-card-image-mask"],[1,"light-card-content"],[1,"light-operation-param"],["aria-label","light defect switch",3,"color","ngModel","ngModelChange"],["draggable","true","matTooltip","Click or scan or drag QR Code onto context filter to switch this light","matTooltipPosition","above",1,"light-map-card-image-qrcode",3,"title","qrdata","usesvg","level","dragstart","click"],["qrCodeTooltip","matTooltip"],[1,"app-heading-no-top-margin"],[1,"light-card-context"],[1,"light-card-slider-label"],[3,"min","max","tickInterval","step","thumbLabel","ngModel","ngModelChange"],[1,"app-card-footer-link-group"],["mat-button","","href","https://github.com/coatyio/coaty-examples/tree/master/remote-operations/js","target","_blank",3,"matTooltip"],["src","./assets/images/github-icon.svg","alt","github-logo"],["mat-button","","href","https://coaty.io","target","_blank"],["src","./assets/images/coaty-logo-accent.svg","alt","coaty-logo"]],template:function(t,e){if(1&t&&(h.Sb(0,"mat-card",0),h.Sb(1,"mat-card-header"),h.Ob(2,"a",1),h.Sb(3,"mat-card-title",2),h.yc(4),h.fc(5,"async"),h.Rb(),h.Sb(6,"mat-card-subtitle",3),h.yc(7),h.Rb(),h.wc(8,O,2,2,"mat-icon",4),h.fc(9,"async"),h.Rb(),h.wc(10,S,1,2,"img",5),h.fc(11,"async"),h.wc(12,R,2,0,"ng-template",null,6,h.xc),h.wc(14,I,20,26,"mat-card-content",7),h.Ob(15,"mat-divider",8),h.wc(16,P,11,9,"mat-card-footer",9),h.Rb()),2&t){var n=h.oc(13);h.Bb(4),h.Ac("",h.gc(5,9,e.appContext.context$)," "),h.Bb(3),h.Cc("Building ",null==e.lightContext?null:e.lightContext.building," \u22c5 Floor ",null==e.lightContext?null:e.lightContext.floor," \u22c5 Room ",null==e.lightContext?null:e.lightContext.room," "),h.Bb(1),h.kc("ngIf",h.gc(9,11,e.brokerConnectionInfo$)),h.Bb(2),h.kc("ngIf",h.gc(11,13,e.lightColor$))("ngIfElse",n),h.Bb(4),h.kc("ngIf",e.lightContainer),h.Bb(2),h.kc("ngIf",null==e.lightContainer?null:e.lightContainer.runtime.commonOptions.agentInfo)}},directives:[f.a,f.f,f.c,f.j,f.i,d.m,p.a,m.a,C.a,f.g,f.d,v.a,y.g,y.i,k.a,x.a,f.e,_.a],pipes:[d.b,d.e,w],styles:[".light-card-dark[_ngcontent-%COMP%]{background:#37474f;color:#eceff1}.light-card-divider-dark[_ngcontent-%COMP%]{background:#607d8b}.light-card-subtitle-dark[_ngcontent-%COMP%]{color:#b0bec5}.light-card-header-avatar[_ngcontent-%COMP%]{background-image:url(/coaty-examples/remote-operations/assets/images/light-bulb-avatar.jpg);background-size:cover}.light-card-title-icon[_ngcontent-%COMP%]{margin-left:auto;margin-right:32px}.light-operation-param[_ngcontent-%COMP%]{color:#424242;display:flex;align-items:center;flex:0 0 auto;position:absolute!important;margin-top:calc(-65% + 8px)!important;left:12px;right:8px}.light-card-image-mask[_ngcontent-%COMP%]{background-image:url(/coaty-examples/remote-operations/assets/images/light-bulb.jpg);background-size:cover;background-color:transparent;background-blend-mode:overlay;transition:background-color 1s linear}.light-map-card-image-qrcode[_ngcontent-%COMP%]{position:absolute!important;margin-top:calc(-30vw - 34px)!important;width:30vw;height:30vw;left:8px;right:8px;border:4px solid transparent;border-radius:4px;cursor:-webkit-grab;cursor:grab}.light-map-card-image-qrcode[_ngcontent-%COMP%]:hover{border-color:#ffd740}.light-card-content[_ngcontent-%COMP%]{margin-bottom:8px}.light-card-context[_ngcontent-%COMP%]{display:flex;align-items:center}.light-card-slider-label[_ngcontent-%COMP%]{align-self:baseline;min-width:4em}"],changeDetection:0}),j)}],B=((M=function t(){_classCallCheck(this,t)}).\u0275mod=h.Lb({type:M}),M.\u0275inj=h.Kb({factory:function(t){return new(t||M)},imports:[[r.c.forChild(T)],r.c]}),M),q=((L=function t(){_classCallCheck(this,t)}).\u0275mod=h.Lb({type:L}),L.\u0275inj=h.Kb({factory:function(t){return new(t||L)},imports:[[i.a,B]]}),L)}}]);