# Coaty JS - Sensor Things Example

[![Powered by Coaty 2](https://img.shields.io/badge/Powered%20by-Coaty%202-FF8C00.svg)](https://coaty.io)
[![TypeScript](https://img.shields.io/badge/Source%20code-TypeScript-007ACC.svg)](http://www.typescriptlang.org/)
[![License](https://img.shields.io/badge/License-MIT-blue.svg)](https://opensource.org/licenses/MIT)

## Table of Contents

* [Introduction](#introduction)
* [Installation](#installation)
  * [Install and build the sensor service](#install-and-build-the-sensor-service)
  * [Install and build the dashboard](#install-and-build-the-dashboard)
* [Start-up](#start-up)
* [Project structure](#project-structure)
* [Components](#components)
  * [Dashboard](#dashboard)
  * [Sensor service](#sensor-service)

## Introduction

_This README assumes you are already familiar with
[Sensor Things API](https://coatyio.github.io/coaty-js/man/sensor-things-guide/)
and [Coaty communication](https://coatyio.github.io/coaty-js/man/communication-protocol/)._

The SensorThings example demonstrates how Coaty and the SensorThings API can be
used to manage a self-discovering network of sensors.

This example is composed of:

* a web dashboard to explore the sensor network,
* sensor service(s) with a configurable Thing and predefined sensors.

**Note :** Any thing and sensor using the SensorThings API and Coaty can be used
with this example. In fact, dashboard knows nothing specific about things and
sensors. It just listens to `Advertise` events on `Thing` and `Sensor` objects
and updates its list of available things and sensors. Thus to be visible on the
dashboard, a sensor and its thing just has to be advertised and made
discoverable according to the SensorThings API.

## Installation

This example has its own npm package definition and a simple build environment
based on npm scripts.

To begin with, make sure that the `Node.js` JavaScript runtime (version 8 or
higher) is globally installed on your target machine. Download and installation
details can be found [here](http://nodejs.org/).

Then, checkout the SensorThings example sources from
[here](https://github.com/coatyio/coaty-examples/tree/master/sensor-things/js).

### Install and build the sensor service

```sh
cd sensor
npm install
npm run build
```

### Install and build the dashboard

```sh
cd dashboard
npm install
npm run build
```

### Install a broker

Before starting the SensorThings example, you need an MQTT broker listening on
port 1883 and websocket port 9883. You can install and run your preferred broker
or use the development broker that comes bundled with the Coaty JS framework. To
use it, just run

```sh
cd broker
npm install
```

## Start-up

Once components are installed and built, execute `cd broker && npm start` to
start the MQTT broker. For debugging and introspection, you can also start the
Coaty broker in verbose mode (`npm run start:verbose`), so that all message
subscriptions and published messages are traced in the console window.

To start a sensor service, execute `cd sensor && npm start` in a separate
console window. You are prompted to configure your thing and sensors.

To start the dashboard, execute `cd dashboard && npm start` in a separate
console window. This will open the dashboard web UI in your default browser.

## Project Structure

Here is the folder structure of the SensorThings example. To keep it readable,
only important files are displayed:

```
├── dashboard/
│   ├── ....                                 - Angular infrastructure
│   └── src/
│      └── app/
│           ├── ...                          - miscellaneous resources for browser app
│           ├── agent.config.ts              - dashboard agent configuration
|           ├── agent.info.ts                - dashboard agent info auto-generated by build script
│           ├── app.component.ts|.html|.scss - Angular root component
│           ├── app.module.ts                - Angular module definition
│           ├── app-routing.module.ts        - Angular routing configuration
│           ├── main.ts                      - Angular bootstrap file, augmented with Coaty integration
|           └── controller/                  - custom controllers
│               ├── sensor-things-controller.ts  - Coaty controller for sensors and things
|           └── pipes/                       - custom Angular pipes
│           └── sensor/                      - Sensor network page
|           |   ├── object-network.component.ts    - Displays the object graph
│           |   ├── sensor.component.html    - HTML template for object page
│           |   └── sensor.component.ts      - business logic for object page. Contains self discovery algorithm.
│           └── welcome/                     - start page for selecting things
│              ├── welcome.component.html    - HTML template for thing selection page
│              └── welcome.component.ts      - business logic for thing selection page
├── broker/
│   └── package.json                         - npm scripts to start Coaty development broker
├── README.md                                - this document
└── sensor/
    |── .env                                 - default environment variables (broker URL)
    ├── gulpfile.js                          - gulp tasks for building and linting
    ├── package.json                         - project package definition
    |── tsconfig.json                        - TypeScript compiler options
    |── tslint.json                          - TypeScript linter options
    └── src/
        ├── agent.ts                         - sensor agent configuration and startup
        ├── agent.info.ts                    - sensor agent info auto-generated by build script
        └── sensor-thing-controller.ts       - sensor agent communication logic

```

Each component of the example is designed to build and run independently. If you
want to use a non-default MQTT broker IP/port configuration, adjust
`sensor/.env` and `dashboard/src/environments/*.ts` files accordingly.

## Components

### Dashboard

Dashboard web app is just a viewer for sensors and related objects. It displays
the available sensors and allows to dive into their object networks by clicking
their names.

Once a sensor is selected, the dashboard observes incoming observations on the
channel of the sensor. The network of sensors is discovered using these
observations.

The dashboard web app is build with [Angular](https://angular.io) and [Angular
CLI](https://github.com/angular/angular-cli). To get more help on the Angular
CLI use `npm run ng help` or check out the [Angular CLI
README](https://github.com/angular/angular-cli/blob/master/README.md).

For details on integrating Coaty in an Angular project, see [Coaty JS Developer
Guide](https://coatyio.github.io/coaty-js/man/developer-guide/#coaty-and-angular-cli).

### Sensor service

Sensor script simulates the behaviour of predefined sensor(s). Once launched,
customize your thing and sensors by defining a name, a location, and a metric to
monitor load average, free memory, or uptime. Then, based on your choice,
sensors are created and connected to one automatically created Thing.

Each sensor will:

* publish sensor data every 5 seconds on its observation channel (channelId is
  the objectId of the Sensor),
* listen to discover events and resolve them if the discovered id refers to one
  of its related objects.

Default settings can be changed in `sensor/agent.ts`.

You can build your own SensorThings compliant sensor script and use it with the
dashboard. Such a sensor and its thing just has to be advertised and made
discoverable according to the SensorThings API.

---
Copyright (c) 2018 Siemens AG. This work is licensed under a
[Creative Commons Attribution-ShareAlike 4.0 International License](http://creativecommons.org/licenses/by-sa/4.0/).
